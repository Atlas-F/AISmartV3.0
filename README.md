# AISmartV3.0（C++ & QT）

The AISmart V3.0 Written by C++ &amp; QT

AI 小智 小型嵌入式智能助手，使用deepseek。

基于V2.0基础，使用C++重构模块化接口，使用QT重新设计界面

```
一个以AI 为核心、具备可扩展的嵌入式瑞士军刀，兼顾软硬件灵活性
模块化、接口清晰、文档完善、逐步迭代
```



```
	该项目是在此前AISmart的lvgl版本与curl版本开发的项目基础上，使用C++和QT进行的重构，使用QT和C++对项目进行OOP优化，借助QT内部的多样化的功能模块，简化开发与代码量，同时提升开发效率。同时舍弃了大量的源码.
	但由于是第一次接触C++和QT，所以该版本是作为测试版，很多内容较为粗糙。

环境说明：
	操作系统：Win11
	IDE：QtCreator 17.0.0 /
		Designer 6.9.1 (MinGW 13.1.0 64-bit)
	库/包：Openssl 1.1.1 /

	QT pro 模块：
		core gui network multimedia multimediawidgets

说明：
1、截至本次提交，目前开发完成内容如下：

- 1）、指定城市地址天气情况获取，使用心知天气的免费API。硬编码 Key。

- 2）、动画类，目前设计的动画功能有： 滑入动画、滑出动画、淡入动画、淡出动画、颜色变化动画、复杂组合动画、弹跳动画、摇摆动画、路径动画、序列
动画、翻转动画。目前滑动、淡入、弹跳动画已测试。
	动画类作为纯工具类进行设计，预留对象和参数接口用于自定义使用，动画使用信号与槽函数连接的方式进行，通过主动给发送自定义信号的方式执行动画。

- 3）、摄像头图像识别等相关功能，目前已经测试可以进行截图、录视频。使用电脑摄像头执行

- 4）、deepseek多轮对话，使用QT内置网络模块，设置请求头，使用自定义函数Makeuphuman()与MakeupAI()将用户输入与
AI输出添加到完整请求体，将相关请求链变量设为class deepseekTalk私有：    QNetworkAccessManager
manager;QNetworkRequest request;QJsonObject rootObj;QJsonArray
mesgArray;QNetworkReply * reply;  以达到全局访问添加效果，点击按钮发送提交。

问题与故障：
1、使用硬编码key的简易操作方式，不安全
2、所有的界面设计都非常简陋粗糙
3、deepseek对话，一次输入完成后，后续再次输入需要手动删除文本
4、内容未整合，所有功能均为单独窗口
```



***



## 1. 项目基本信息

### 	名称简介：

​	**名称**：AI小智

​	**简介**：小型嵌入式智能助手设备，通过API接入Deepseek，支持时间、日期、天气显示，对话面板，通过文本进行交互（后续支持语音），支持日常问题沟通交流

### 项目状态

- 开发中



## 待改进

- 交互



## 2. 功能特性

#### 需求设计功能

- deepseek多轮对话
- 天气情况以及时间获取
- 摄像头功能
- 动画类
- 多应用数据互通，调用AI分析（应用间通信）（待开发）



#### 核心功能

**deepseek**

​	响应解析：解析Json响应 并提取内容

​	对话管理：创建销毁会话，维护**api** key，

​	文本分析：语气分析，情绪回应

​	令牌统计： 跟踪API使用情况和成本估算



**API 集成（V3.0 更新）**

 - 天气

   

**用户界面：**

​	多界面交互



**输入系统：**

​	文本输入：支持多行文本输入



#### 主要特点

使用C++ 和QT进行重构

​	辅助功能：

​		工具集成：

​			时间管理、日历天气

​			计算功能、翻译功能



#### 项目截图/演示

​	**界面**







## 3.核心功能实现

#### 流程架构







#### 常态界面

​	



#### 时间界面

​	





#### AI界面

通过管理一个对话类来实现，初始化时用户不发送消息，进行一次空请求，将 

	QNetworkAccessManager manager;
	QNetworkRequest request;
	QJsonObject rootObj;
	QJsonArray mesgArray;
	QNetworkReply * reply;

上述变量设置为私有，每次点击即将用户消息



## 4. 快速开始

### 4.1 环境要求

#### 技术栈说明

​	-  **操作系统**

- windows 10/11

- 


​	- **开发环境**：

- IDE：QtCreator 17.0.0 /
  		Designer 6.9.1 (MinGW 13.1.0 64-bit)
- 构建工具：CMake、 qmake

##### 		- 核心依赖库

- 


​	- **图形界面**

- 


​	- **API集成**

- Deepseek
- 心知天气

​	- **版本管理**

- Github

### 4.2 安装步骤







### 4.3 配置说明

#### 库配置



### 4.4 运行示例





## 5. 项目结构



├──AiSmart /		# 使用SquareLine 快速设计导出的UI源码



​		└── ui_events.h



## 6. API 文档

- 接口说明
  - 
- 请求/响应示例
  - 

- 错误码说明

## 7. 开发指南

- 代码规范
  - 
  - 所有公共函数必须有Doxygen注释
  - 添加新功能时提供单元测试

- 提交规范
  - 新建分支 new feature
  - git commit -m '时间戳-拉取分支-更新版本号-更新内容概述'

- 分支管理
  - 不要直接修改main分支

- 测试要求

## 8. 贡献指南

- 如何贡献代码
  1. Fork项目仓库
  2. 创建特性分支：`git checkout -b feature/new-feature`
  3. 提交更改：`git commit -m 'Add new feature'`
  4. 推送到分支：`git push origin feature/new-feature`
  5. 创建Pull Request
     - 欢迎通过GitHub提交贡献！
- PR 流程
- 开发环境搭建
- 联系方式

## 9. 常见问题

- FAQ

  - 一处改动时要注意其他关联地方，引用等

- 故障排除

  - 点击对话框刷新文本内容

  - 对话循环，正常对话即可，inputlogo回调函数内初始化创建会话，长按唤出键盘，点击提交输入内容

  - 使用Square Line进行快捷设计导出时部分源码文件会被覆盖掉，高危操作，要注意提前保护

  - 在UIevent.c中存储自定义的事件函数（应该在外部再设置自定义文件将自定义函数存储在里面，放置被覆盖）

    自定义的函数不会被覆盖

  - 初始会话段错误：段错误原因是被意外覆盖为字符串数据-> 内存布局

    

- 已知问题

  - 开发板时间获取与实际不同，需要手动校准

  - 对话的循环逻辑是死的，只能强制退出

  - ARM架构找不到库文件，已经发送到开发板上了，但是开发板找不到（已解决）

  - （高危：api key暴露，不安全，要使用更加安全的方式！）

  - 链接openssl配置支持https协议

  - 会话时可能出现段错误

    - #####  段错误排查（2025.7.6）

      depmaintalk()函数中->deepseek_send_message()函数

      -> struct APIResponse *response* = call_deepseek(*session*->*api_key*, *message*);

      -> 变量名冲突

      -> session 的地址应该是在每次输出时都是不变的吗？input的长度是所有输入加起来的

      还是单次输入的长度？

      -> 段错误原因是被意外覆盖为字符串数据

      -> 内存布局

  - 中文输入法导致的段错误与渲染引擎权限不足问题

    - 使用9键模式，会在进入程序时段错误，无法进入，使用26键模式，可以正常进入程序，但是会在输入模块出现段错误
    - 候选面板创建了但是没有显示
    - 可能是权限不足的问题，导致无法正确初始化，返回空指针，进而引发段错误

  - 网络超时，timeout was reached

  - 栈使用量异常，可能是计算错误

  - 配置环境ssl证书

  - 使用环境变量配置API Key：strdup函数会导致段错误，原因未知

  - 不能对getenv返回的值解引用吗

  - 在Square Line 中对ui布局进行更改后，要注意代码中引用时的变化

  - 将所有的自定义文件放置在一个文件夹下，然后使用一个头文件全部包含，在别的源文件中使用时只需包含该头文件即可，减少重复操作

    - 聚合头文件（伞头文件）

- 改进总结

  - 段错误
    - 遇到段错误，原因大致几类，普遍与内存以及指针相关，可使用printf逐步定位分析，并进行错误处理检测，检测是否为空指针
    - 进入函数前定位，进入函数后定位，但是不显示，表现为不执行函数，一般可能是栈的使用出现问题，调用太深或者递归太深
    - GDB使用

  - 输入检查
    - 边界测试
    - 内存检查
    - 压力测试
    - 鲁棒性

  - 魔术字是什么？
  - 异常指针值
  - 内存对齐:8自己二对齐如：（如 `0x555555...` 或 `0x7fff...`），不符合则很难工厂堆/栈内存分配的特征
    - 当指针被意外赋值为字符串内容时，其值通常会呈现出可识别的 ASCII 模式
    - 调试经验中，某些指针值模式会立即触发警惕：
      - **全零值**：通常表示未初始化的指针（`NULL`）
      - **全 1 值**：可能是野指针或内存释放后未置空
      - **ASCII 模式**：指针值包含可识别的字符（如 `0x616263` → "abc"）
      - 优先检查：
        - 字符串操作函数（`strcpy`、`sprintf`、`gets` 等）
        - 数组越界或缓冲区溢出
        - 结构体成员顺序与对齐问题
  - cURL、cJSON学习掌握，
  - deepseek对话稚只能进行单次对话，无法回溯上下文，因为每次请求只发送当前消息


## 10. 更新日志

- 版本历史
  - **2025.6.13 V1.0.1**
    - 休眠界面表情图间隔一秒随机切换
  - **2025.6.14 V1.0.2**

    - 手势滑动切换屏幕，左滑或者右滑
    - 向下滑动切换时间显示
    - 在第二屏设置模拟AI与人类对话，显示文本 ，使用文本文档模拟对话内容
  - **2025.6.15 V1.0.3**
    - 点击humanpanel，更新文本内容，humanpanel和AIPanel轮流显示对话文本，模拟对话
    - ubuntu可以正常模拟，开发板不行
  - **2025.6.16 V1.0.4**

    - 在ubuntu上面可以实现调用Deepseek，进行英文文本格式的输入与输出对话，但是逻辑顺序需要修正，循环的逻辑无法人为控制，应该在输出之后等待输入完成在进行下一次分析与输出
  - **2025.6.17 V1.0.5**

    - 修正了deepseek对话逻辑，获取完整输入，在inputlogo按键回调函数内部即创建会话，长按唤出键盘与输入框，点击提交输入内容。通过全局变量沟通LVGL和deepseek会话
    - 使用辅助函数获取完整文本框内容
  - **2025.6.20 V1.0.6**
    - 开发板上安装openssl链接curl库，否则不支持https协议，curl库与openssl配置版本匹配要求较高，先配置交叉编译openssl库（三步走：./configure  --  make -- make install），再配置curl库。
    - SSL证书问题待解决
  - **2025.7.5 V2.0.1**
    - SSL证书
    - 在新虚拟机Ubuntu-24.04或者WSL上复原AISmartV1.0
      - 似乎有超时段错误，
      - 如何使用物理键盘输入？

    - 测试网络
    - 构思项目具体实现
  - **2025-7-6 V2.0.1**
    更新：
        - 修复之前的段错误问题
            原因：内存布局原先存在潜在问题，使得在处理输入input时，get_full_text函数可能会导致input长度溢出越界，并侵入到session的内存区域
            但是目前并不能完全肯定是该原因，还进行了其他的测试，只是该方法下目前在暂未出问题。
            还需要对get_full_text函数进行优化
            - 调用api-key 似乎也有潜在问题
                - 拟添加中文输入法功能，但是存在段错误以及渲染设备的权限问题，
                  可能原因：中文输入法的复杂渲染使得原本的权限问题升级，但是甚至已经开了3d加速图形。
                  若是是需要使用中文输入法，还需要进一步的调试
                - 拟设置api key到环境变量中，避免硬编码
                - 在编写程序时注意进行边界检查，输入检查，异常检查，压力测试。增强健壮性。

       - github 提交存在问题，由于重新安装了WSL，并且开发文件目录变更，提交出现问题
  - **2025-7-7 V2.0.2**
    - 不适用API KEY 硬编码的方式，而是使用别的方法，增强安全
      - 使用环境配置key，但是会出现段错误
    - 输入缓冲区有溢出风险
  - **2025-7-8 V2.0.3**
    - 使用环境变量加载api key。
    - 加载天气功能，定位
    - 架构构思：
      - 将所有的自定义代码放在项目根目录下，置于一个源文件中，并编写头文件，在进行项目导出时，只需加入一个头文件即可快速将项目恢复到上衣状态
    - 项目中的无用资源较多，挤压有效资源空间，需要清理，会在编译过程中出现错误，
      - ![](C:\Users\phoen\Pictures\7ee3e257-eb72-46dd-9f90-0d9a44e75c5d.png)
      - 这种情况下，先使用make clean ，再进行make，可临时解决问题
    - 增加多轮对话，联系上下文。
      - 将消息内容添加到一个数组中， 再进行拼接成一个完整的字符串，每次进行拼接前先要重置
      - 增大输出缓冲区
  - **2025-7-11 V2.0.3** 补丁
    - 输入时，第一次点击输不进去
    - 需要对cjson进行检查
    - 
  - **2025-7-12 V2.0.4**
    - 天气功能，根据API的响应对地址和相应的天气情况显示对应的UI
      - 显示UI图片，依靠子部件的顺序排列，从API响应获取的code即是对应天气图片在容器内的序号 ，依靠序号定位，所以不能打乱
  - **2025-7-13 V2.0.5**
    - 多轮对话与联系上下文：
      - 基本实现，目前主要是错误处理与内存管理不完善
        - 错误处理：timeout 错误时的资源管理等，要释放资源。避免下次请求导致的二次释放
        - 内存管理：有些全局变量资源没有正确释放，虽然不会引起错误，但是会导致内存泄漏
  - **2025-7-21 V3.0.1**
    - 大改动，使用C++进行重构，抽象接口层，降低耦合，增强扩展性
      - 使用meyers单例重构deepseek会话和curl的管curl_global_initt，确保全局唯一
      - 使用类存储记录deepseek相关变量和操作：*DPSKSession会话结构体*、*DeepSeek对话Curl初始化*、*deepseek请求体构建*、*deepseek 响应解析，纯解析类*。
      - deepseek网络对话部分类基本完成重构，暂未进行逻辑测试。
  - **2025-7-25 V3.0.2**
    - 实现天气获取、时间显示、DeepSeek多轮对话
  - **2025-7-26 V3.0.**
    - 预计实现：动画类
    - 实现动画类。滑动、淡入淡出、弹跳等。。。
  - **2025-7-26 V3.0.**
    - 预计实现：摄像头调用
      - 问题：
        - 如何实现界面跳转？
- 重要更新
  - **2025-7-21 V3.0.1**
    - 使用C++进行重构。
- 破坏性变更

## 11. 版权和许可

- 开源协议
- 作者信息：LFG
- 相关链接







## 

# Note

###  启动

若使用虚拟机则需要使用NAT网络连接windows powershell 使用vmrun启动虚拟机，并进行端口转发设置，



将功能模块封装成函数，返回值



#### 问题

加入拼音后出现渲染权限问题，需要更高级的渲染 OpenGL/EGL

libEGL warning: failed to open /dev/dri/renderD128: Permission denied

libEGL warning: failed to open /dev/dri/renderD128: Permission denied

libEGL warning: failed to open /dev/dri/card0: Permission denied













​	

